<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>QU·∫¢N L√ù D·ª∞ √ÅN (B·∫¢N CHU·∫®N)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --available: #27ae60; --sold: #c0392b; --bg-color: #e8f5e9; --lot-size: 38px; --gap: 6px; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #f0f2f5; background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 20px 20px; }
        
        /* HEADER */
        .header { background: white; padding: 0 10px; height: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100; }
        .header h1 { margin: 0; font-size: 14px; font-weight: 800; color: #2c3e50; text-transform: uppercase; }
        .btn-auth { background: #2980b9; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; }

        /* THANH MENU */
        .filter-bar { background: #34495e; height: 50px; display: flex; align-items: center; overflow-x: auto; white-space: nowrap; padding: 0 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 99; position: relative; }
        .filter-btn { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #ddd; padding: 6px 15px; margin-right: 8px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .filter-btn.active { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f1c40f; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* KHUNG B·∫¢N ƒê·ªí */
        .map-wrapper { width: 100%; height: calc(100vh - 100px); overflow: auto; -webkit-overflow-scrolling: touch; padding: 30px 0; position: relative; background: #e5e5e5; }
        #zoomTarget { transform-origin: top center; transition: transform 0.2s ease-out; display: flex; flex-direction: column; align-items: center; padding-bottom: 100px; }
        .area-box { background: white; padding: 15px; margin-bottom: 30px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #ddd; min-width: 1000px; margin-left: auto; margin-right: auto; }
        .area-title { font-weight: 800; margin-bottom: 10px; border-bottom: 2px solid #333; padding-bottom: 5px; text-align: center; font-size: 16px; color: #2c3e50; }
        .row { display: flex; justify-content: flex-end; margin-bottom: var(--gap); }
        .lot { width: var(--lot-size); height: var(--lot-size); background-color: var(--available); color: white; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-left: var(--gap); position: relative; flex-shrink: 0; box-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .lot.sold { background-color: var(--sold); }
        .status-icon { position: absolute; font-size: 10px; top: 2px; left: 2px; opacity: 0.7; pointer-events: none; }

        /* ZOOM CONTROLS */
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .zoom-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: white; color: #333; font-size: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .zoom-btn:active { transform: scale(0.9); background: #eee; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px);}
        .modal-box { background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .form-group { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: 700; display: block; margin-bottom: 4px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 12px; background: #2980b9; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px;}
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .status-bar-user { position: absolute; top: 55px; right: 10px; font-size: 10px; color: white; font-weight: bold; z-index: 101; text-shadow: 1px 1px 2px black;}
        .timer { font-size: 30px; width: 60px; height: 60px; border-radius: 50%; border: 3px solid #333; display: flex; justify-content: center; align-items: center; margin: 10px auto; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><h1>B·∫¢N ƒê·ªí D·ª∞ √ÅN</h1><button id="authBtn" class="btn-auth" onclick="toggleAuthModal()">ƒêƒÉng Nh·∫≠p</button></div>
    <div class="filter-bar" id="filterBar"><button class="filter-btn active" onclick="setFilter('all')">T·∫§T C·∫¢</button></div>
    <div class="status-bar-user" id="userStatus">KH√ÅCH</div>
    <div class="map-wrapper" id="mapContainer"><div id="zoomTarget"></div></div>
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()"><i class="fa fa-plus"></i></button>
        <button class="zoom-btn" onclick="resetZoom()" style="font-size:12px">100%</button>
        <button class="zoom-btn" onclick="zoomOut()"><i class="fa fa-minus"></i></button>
    </div>

    <div class="modal-overlay" id="loginModal"><div class="modal-box"><h3 style="text-align:center;">ADMIN LOGIN</h3><div class="form-group"><input type="email" id="loginEmail" placeholder="Email"></div><div class="form-group"><input type="password" id="loginPass" placeholder="Pass"></div><button class="btn-full" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button><button class="btn-full" style="background:#7f8c8d" onclick="closeLogin()">ƒê√≥ng</button></div></div>
    <div class="modal-overlay" id="editModal"><div class="modal-box"><h3 style="text-align:center; border-bottom:1px solid #ddd; padding-bottom:10px;">TH√îNG TIN</h3><div class="form-group"><label>Tr·∫°ng Th√°i:</label><select id="inpStatus"><option value="available">üü¢ M·ªü B√°n</option><option value="sold">üî¥ ƒê√£ B√°n</option></select></div><div class="form-group"><label>Sale:</label><input type="text" id="inpSeller"></div><div class="form-group"><label>Kh√°ch:</label><input type="text" id="inpBuyer"></div><div class="form-group"><label>Ng√†y:</label><input type="date" id="inpDate"></div><div class="form-group"><label>Gi√°:</label><input type="text" id="inpPrice"></div><div class="btn-group"><button class="btn" style="background: #7f8c8d;" onclick="closeEdit()">H·ªßy</button><button class="btn" style="background: #2980b9;" onclick="startConfirm()">L∆∞u</button></div></div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal-box" style="text-align:center;"><h3>X√ÅC NH·∫¨N?</h3><span id="statusLabel" style="font-size:18px; font-weight:bold; display:block; margin:15px 0;">...</span><div class="timer" id="timerDisplay">3</div><div class="btn-group" style="justify-content: center;"><button class="btn" style="background: #e74c3c;" onclick="cancelSave()">H·ª¶Y</button><button class="btn" style="background: #27ae60;" onclick="saveNow()">L∆ØU</button></div></div></div>

    <script>
        // --- 1. S·ª¨A L·ªñI CONFIG (QUAN TR·ªåNG) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBGP9e-4M2hEU3FQe4sfCzMutOXA8Wte44",
            authDomain: "du-an-dat-dai.firebaseapp.com",
            databaseURL: "https://du-an-dat-dai-default-rtdb.asia-southeast1.firebasedatabase.app", // ƒê√É TH√äM LINK CH√ÇU √Å
            projectId: "du-an-dat-dai",
            storageBucket: "du-an-dat-dai.firebasestorage.app",
            messagingSenderId: "744543078305",
            appId: "1:744543078305:web:9759e198b5cbd79cd16de0"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('du_an_phan_lo');
        const auth = firebase.auth();

        // --- 2. C·∫¨P NH·∫¨T S·ªê √î ---
        const mapConfig = [
            { name: "KHU V·ª∞C 1", rows: [27, 29, 31, 31] },
            { name: "KHU V·ª∞C 2", rows: [29, 27, 27, 27] },
            { name: "KHU V·ª∞C 3", rows: [25, 23, 21, 21] },
            { name: "KHU V·ª∞C 4", rows: [18, 16, 12, 10, 10] },
            { name: "KHU V·ª∞C 5", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 6", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 7", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 8", rows: [12, 12, 12, 12] }
        ];

        let currentUser = null; let currentId = null; let dbData = {}; let currentFilter = 'all'; let timer = null; let zoomLevel = 1;

        // INIT
        const filterBar = document.getElementById('filterBar');
        mapConfig.forEach((area, idx) => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn'; btn.innerText = area.name;
            btn.onclick = () => setFilter(idx); filterBar.appendChild(btn);
        });

        function applyZoom() { document.getElementById('zoomTarget').style.transform = `scale(${zoomLevel})`; }
        function zoomIn() { zoomLevel += 0.1; applyZoom(); }
        function zoomOut() { if(zoomLevel > 0.3) zoomLevel -= 0.1; applyZoom(); }
        function resetZoom() { zoomLevel = 1; applyZoom(); }

        auth.onAuthStateChanged((u) => {
            currentUser = u;
            document.getElementById('authBtn').innerText = u ? 'ƒêƒÉng Xu·∫•t' : 'ƒêƒÉng Nh·∫≠p';
            document.getElementById('userStatus').innerText = u ? "ADMIN" : "KH√ÅCH";
        });

        function setFilter(filter) {
            currentFilter = filter;
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => b.classList.remove('active'));
            if(filter === 'all') btns[0].classList.add('active');
            else btns[filter + 1].classList.add('active');
            renderMap();
        }

        function renderMap() {
            const container = document.getElementById('zoomTarget');
            container.innerHTML = '';
            mapConfig.forEach((area, index) => {
                if(currentFilter !== 'all' && currentFilter !== index) return;
                const areaDiv = document.createElement('div'); areaDiv.className = 'area-box';
                areaDiv.innerHTML = `<div class="area-title">${area.name}</div>`;
                area.rows.forEach((count, rIdx) => {
                    const rowDiv = document.createElement('div'); rowDiv.className = 'row';
                    for(let i=1; i<=count; i++) {
                        const id = `k${index+1}_r${rIdx+1}_${i}`;
                        const d = dbData[id] || { status: 'available' };
                        const lot = document.createElement('div'); lot.className = `lot ${d.status}`;
                        lot.innerText = i;
                        if(d.status === 'sold') lot.innerHTML += `<i class="fa fa-lock status-icon"></i>`;
                        lot.onclick = () => handleLotClick(id, `${area.name} - H√†ng ${rIdx+1} - S·ªë ${i}`);
                        rowDiv.appendChild(lot);
                    }
                    areaDiv.appendChild(rowDiv);
                });
                container.appendChild(areaDiv);
            });
            setTimeout(() => { const w = document.getElementById('mapContainer'); w.scrollTo({ left: (w.scrollWidth - w.clientWidth)/1.5, behavior: 'smooth' }); }, 300);
        }

        dbRef.on('value', (s) => { if(s.exists()) dbData = s.val(); renderMap(); });

        function toggleAuthModal() { if (currentUser) { if(confirm("ƒêƒÉng xu·∫•t?")) auth.signOut(); } else { document.getElementById('loginModal').style.display = 'flex'; } }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }
        function handleLogin() { const e = document.getElementById('loginEmail').value; const p = document.getElementById('loginPass').value; auth.signInWithEmailAndPassword(e, p).then(()=>{closeLogin(); alert("‚úÖ OK");}).catch(e=>alert("‚ùå " + e.message)); }
        
        function handleLotClick(id, title) {
            const d = dbData[id] || {};
            if (!currentUser) { if(d.status === 'sold') alert(`üîí ƒê√É B√ÅN\nüí∞ ${d.price || '...'}`); else if(confirm("ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠a?")) document.getElementById('loginModal').style.display = 'flex'; return; }
            currentId = id; document.getElementById('inpStatus').value = d.status || 'available'; document.getElementById('inpSeller').value = d.seller || ''; document.getElementById('inpBuyer').value = d.buyer || ''; document.getElementById('inpDate').value = d.date || ''; document.getElementById('inpPrice').value = d.price || ''; document.getElementById('editModal').style.display = 'flex';
        }
        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
        function startConfirm() {
            const st = document.getElementById('inpStatus').value; const lbl = document.getElementById('statusLabel');
            lbl.innerText = (st === 'sold') ? "üî¥ ƒê√É B√ÅN" : "üü¢ ƒêANG M·ªû B√ÅN"; lbl.style.color = (st === 'sold') ? "#c0392b" : "#27ae60";
            document.getElementById('editModal').style.display = 'none'; document.getElementById('confirmModal').style.display = 'flex';
            let t = 3; document.getElementById('timerDisplay').innerText = t;
            if(timer) clearInterval(timer); timer = setInterval(() => { t--; document.getElementById('timerDisplay').innerText = t; if(t<=0) saveNow(); }, 1000);
        }
        function cancelSave() { clearInterval(timer); document.getElementById('confirmModal').style.display = 'none'; document.getElementById('editModal').style.display = 'flex'; }
        function saveNow() {
            clearInterval(timer); document.getElementById('confirmModal').style.display = 'none';
            const data = { status: document.getElementById('inpStatus').value, seller: document.getElementById('inpSeller').value, buyer: document.getElementById('inpBuyer').value, date: document.getElementById('inpDate').value, price: document.getElementById('inpPrice').value };
            dbRef.child(currentId).set(data).then(()=>alert("‚úÖ L∆∞u xong!")).catch(e=>alert("‚ùå L·ªói: " + e.message));
        }
    </script>
</body>
</html>