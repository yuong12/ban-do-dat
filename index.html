<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SA B√ÄN D·ª∞ √ÅN (FULL INFO)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --available: #27ae60; --sold: #c0392b;     
            --bg-color: #badc58; --lot-size: 30px; --gap: 4px;           
        }

        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden; 
            background-color: var(--bg-color);
        }

        /* HEADER */
        .header { 
            background: white; padding: 0 15px; height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; justify-content: space-between; align-items: center;
            position: relative; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header h1 { margin: 0; font-size: 14px; font-weight: 800; color: #2c3e50; text-transform: uppercase; }
        .btn-auth { background: #2980b9; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; }
        .btn-back { display: none; background: #34495e; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; align-items: center; gap: 5px; }

        /* --- MASTER PLAN --- */
        .master-wrapper {
            width: 100%; height: calc(100vh - 75px);
            overflow: auto; 
            display: flex; justify-content: center; padding: 20px; box-sizing: border-box;
            background-image: radial-gradient(#a3cb38 10%, transparent 10%);
            background-size: 20px 20px;
        }

        .project-layout {
            display: flex; flex-direction: row; gap: 60px;
            align-items: flex-start;
            padding: 40px;
            position: relative;
            transform-origin: top center; transition: transform 0.2s;
        }

        .central-road {
            position: absolute; left: 50%; top: -50px; bottom: -50px; width: 50px;
            background: #535c68; transform: translateX(-50%);
            border-left: 2px dashed rgba(255,255,255,0.5); border-right: 2px dashed rgba(255,255,255,0.5);
            display: flex; justify-content: center; align-items: center;
            writing-mode: vertical-rl; text-orientation: mixed;
            color: rgba(255,255,255,0.3); font-weight: bold; font-size: 20px; letter-spacing: 10px;
            z-index: 0; pointer-events: none;
        }

        .side-column { display: flex; flex-direction: column; gap: 40px; z-index: 1; }

        .area-preview-box {
            background: rgba(255,255,255,0.9); padding: 10px; 
            border-radius: 8px; border: 2px solid #2c3e50;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            cursor: pointer; position: relative;
            transition: transform 0.2s;
        }
        .area-preview-box:hover { transform: scale(1.05); border-color: #f1c40f; z-index: 10; box-shadow: 0 15px 30px rgba(0,0,0,0.25); background: white; }
        
        .area-preview-title {
            text-align: center; font-weight: 800; margin-bottom: 8px; 
            color: #2c3e50; border-bottom: 1px solid #ccc; padding-bottom: 5px;
            font-size: 14px;
        }
        
        .click-hint {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.1); border-radius: 6px;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: 0.2s; font-weight: bold; color: white; text-shadow: 1px 1px 2px black;
            pointer-events: none;
        }
        .area-preview-box:hover .click-hint { opacity: 1; }

        /* --- DETAIL VIEW --- */
        .detail-wrapper { 
            width: 100%; height: calc(100vh - 75px); 
            overflow: auto; display: none;
            background: #f0f2f5;
            padding: 20px 0;
            flex-direction: column; align-items: center;
        }

        .area-detail-box { 
            background: white; padding: 25px; border-radius: 8px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.15); border: 1px solid #ddd;
            min-width: 1000px; margin-left: auto; margin-right: auto;
        }

        .row { display: flex; justify-content: flex-end; margin-bottom: var(--gap); }
        
        .lot {
            width: var(--lot-size); height: var(--lot-size);
            background-color: var(--available); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; border-radius: 3px;
            position: relative; flex-shrink: 0;
            box-shadow: 1px 1px 1px rgba(0,0,0,0.2); 
        }
        .lot.sold { background-color: var(--sold); }
        .status-icon { position: absolute; font-size: 8px; top: 1px; left: 1px; opacity: 0.8; }

        .area-preview-box .lot { pointer-events: none; }
        .area-detail-box .lot { cursor: pointer; transition: 0.1s; }
        .area-detail-box .lot:hover { transform: scale(1.2); z-index: 5; }

        /* CONTROLS & UI */
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 99; }
        .zoom-btn { width: 40px; height: 40px; border-radius: 50%; background: white; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        .status-bar { background: #34495e; color: white; padding: 5px; text-align: center; font-size: 12px; font-weight: bold; height: 25px; }
        
        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px);}
        .modal-box { background: white; width: 85%; max-width: 350px; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 12px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; display: block; }
        label { font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;}
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .timer { font-size: 40px; margin: 10px auto; display: block; text-align: center; font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>

    <div class="status-bar">
        User: <span id="userStatus" style="background:#f1c40f; color:black; padding:2px 5px; border-radius:4px;">KH√ÅCH</span>
    </div>

    <div class="header">
        <div class="header-left">
            <button id="backBtn" class="btn-back" onclick="goHome()"><i class="fa fa-arrow-left"></i> V·ªÄ TO√ÄN C·∫¢NH</button>
            <h1 id="pageTitle">SA B√ÄN D·ª∞ √ÅN</h1>
        </div>
        <button id="authBtn" class="btn-auth" onclick="toggleAuthModal()">ƒêƒÉng Nh·∫≠p</button>
    </div>

    <div class="master-wrapper" id="masterView">
        <div class="project-layout" id="projectLayout">
            <div class="central-road">ƒê∆Ø·ªúNG 30M</div>
            <div class="side-column" id="colLeft"></div>
            <div class="side-column" id="colRight"></div>
        </div>
    </div>

    <div class="zoom-controls" id="zoomControls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">-</button>
    </div>

    <div class="detail-wrapper" id="detailView"></div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h3 style="text-align:center;">ADMIN LOGIN</h3>
            <div class="form-group"><input type="email" id="loginEmail" placeholder="Email"></div>
            <div class="form-group"><input type="password" id="loginPass" placeholder="Pass"></div>
            <div class="btn-group"><button class="btn" style="background:#2980b9" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button><button class="btn" style="background:#7f8c8d" onclick="closeLogin()">ƒê√≥ng</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <h3 style="text-align:center; border-bottom:1px solid #ddd; padding-bottom:10px;">TH√îNG TIN L√î</h3>
            <div class="form-group"><label>Tr·∫°ng Th√°i:</label><select id="inpStatus"><option value="available">üü¢ M·ªü B√°n</option><option value="sold">üî¥ ƒê√£ B√°n</option></select></div>
            <div class="form-group"><label>Sale:</label><input type="text" id="inpSeller"></div>
            <div class="form-group"><label>Kh√°ch:</label><input type="text" id="inpBuyer"></div>
            
            <div class="form-group"><label>S·ªë ƒêi·ªán Tho·∫°i:</label><input type="text" id="inpPhone" placeholder="09xxxx"></div>
            <div class="form-group"><label>V·ªã Tr√≠:</label><input type="text" id="inpLocation" placeholder="V√≠ d·ª•: G√≥c ƒë∆∞·ªùng A..."></div>
            <div class="form-group"><label>Ng√†y:</label><input type="date" id="inpDate"></div>
            <div class="form-group"><label>Gi√°:</label><input type="text" id="inpPrice"></div>
            <div class="btn-group"><button class="btn" style="background:#7f8c8d" onclick="closeEdit()">H·ªßy</button><button class="btn" style="background:#2980b9" onclick="startConfirm()">X√°c Nh·∫≠n</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box" style="text-align:center;">
            <h3>X√ÅC NH·∫¨N THAY ƒê·ªîI?</h3>
            <div id="statusLabel" style="font-weight:bold; margin:10px;">...</div>
            
            <div class="timer" id="timerDisplay">10</div>
            <p style="font-size:12px; color:#555;">Vui l√≤ng b·∫•m <b>L∆ØU</b> tr∆∞·ªõc khi h·∫øt gi·ªù.<br>H·ªá th·ªëng s·∫Ω t·ª± H·ª¶Y n·∫øu b·∫°n kh√¥ng b·∫•m.</p>
            
            <div class="btn-group" style="justify-content:center">
                <button class="btn" style="background:#e74c3c" onclick="cancelSave()">H·ª¶Y B·ªé</button>
                <button class="btn" style="background:#27ae60" onclick="saveNow()">L∆ØU NGAY</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGP9e-4M2hEU3FQe4sfCzMutOXA8Wte44",
            authDomain: "du-an-dat-dai.firebaseapp.com",
            databaseURL: "https://du-an-dat-dai-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "du-an-dat-dai",
            storageBucket: "du-an-dat-dai.firebasestorage.app",
            messagingSenderId: "744543078305",
            appId: "1:744543078305:web:9759e198b5cbd79cd16de0"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('du_an_phan_lo');
        const auth = firebase.auth();

        const mapConfig = [
            { name: "KHU V·ª∞C 1", rows: [27, 29, 31, 31] },
            { name: "KHU V·ª∞C 2", rows: [29, 27, 27, 27] },
            { name: "KHU V·ª∞C 3", rows: [25, 23, 21, 21] },
            { name: "KHU V·ª∞C 4", rows: [18, 16, 12, 10, 10] },
            { name: "KHU V·ª∞C 5", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 6", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 7", rows: [12, 12, 12, 12] },
            { name: "KHU V·ª∞C 8", rows: [12, 12, 12, 12] }
        ];

        let currentUser = null; let currentId = null; let dbData = {}; 
        let zoomLevel = 1; let timer = null;

        auth.onAuthStateChanged((u) => {
            currentUser = u;
            document.getElementById('authBtn').innerText = u ? 'ƒêƒÉng Xu·∫•t' : 'ƒêƒÉng Nh·∫≠p';
            document.getElementById('userStatus').innerText = u ? "ADMIN" : "KH√ÅCH";
        });

        function renderMaster() {
            const leftCol = document.getElementById('colLeft');
            const rightCol = document.getElementById('colRight');
            leftCol.innerHTML = ''; rightCol.innerHTML = '';

            mapConfig.forEach((area, idx) => {
                const box = document.createElement('div');
                box.className = 'area-preview-box';
                box.onclick = () => openDetail(idx);
                
                const title = document.createElement('div');
                title.className = 'area-preview-title';
                title.innerText = area.name;
                box.appendChild(title);

                area.rows.forEach((count, rIdx) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'row';
                    for(let i=1; i<=count; i++) {
                        const id = `k${idx+1}_r${rIdx+1}_${i}`;
                        const d = dbData[id] || { status: 'available' };
                        const lot = document.createElement('div');
                        lot.className = `lot ${d.status}`;
                        lot.innerText = i;
                        if(d.status === 'sold') lot.innerHTML += `<i class="fa fa-lock status-icon"></i>`;
                        rowDiv.appendChild(lot);
                    }
                    box.appendChild(rowDiv);
                });

                const hint = document.createElement('div');
                hint.className = 'click-hint';
                hint.innerHTML = '<i class="fa fa-edit"></i>&nbsp;CH·ªàNH S·ª¨A';
                box.appendChild(hint);

                if(idx < 4) leftCol.appendChild(box); else rightCol.appendChild(box);
            });
        }

        function openDetail(idx) {
            document.getElementById('masterView').style.display = 'none';
            document.getElementById('zoomControls').style.display = 'none';
            document.getElementById('detailView').style.display = 'flex';
            document.getElementById('backBtn').style.display = 'flex';
            document.getElementById('pageTitle').innerText = "CH·ªàNH S·ª¨A: " + mapConfig[idx].name;
            
            const container = document.getElementById('detailView');
            container.innerHTML = '';
            
            const area = mapConfig[idx];
            const box = document.createElement('div');
            box.className = 'area-detail-box';
            
            area.rows.forEach((count, rIdx) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                for(let i=1; i<=count; i++) {
                    const id = `k${idx+1}_r${rIdx+1}_${i}`;
                    const d = dbData[id] || { status: 'available' };
                    const lot = document.createElement('div');
                    lot.className = `lot ${d.status}`;
                    lot.innerText = i;
                    lot.style.width = "40px"; lot.style.height = "40px"; lot.style.fontSize = "12px";
                    
                    if(d.status === 'sold') lot.innerHTML += `<i class="fa fa-lock status-icon"></i>`;
                    
                    lot.onclick = (e) => {
                        e.stopPropagation();
                        handleLotClick(id, `${area.name} - H√†ng ${rIdx+1} - S·ªë ${i}`);
                    };
                    rowDiv.appendChild(lot);
                }
                box.appendChild(rowDiv);
            });
            container.appendChild(box);
            
            setTimeout(() => { container.scrollTo({ left: (container.scrollWidth - container.clientWidth)/1.5, behavior: 'smooth' }); }, 300);
        }

        function goHome() {
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('masterView').style.display = 'flex';
            document.getElementById('zoomControls').style.display = 'flex';
            document.getElementById('pageTitle').innerText = "SA B√ÄN D·ª∞ √ÅN";
            renderMaster();
        }

        dbRef.on('value', (s) => {
            if(s.exists()) dbData = s.val();
            if(document.getElementById('masterView').style.display !== 'none') renderMaster();
            else {
                const title = document.getElementById('pageTitle').innerText;
                const areaName = title.replace("CH·ªàNH S·ª¨A: ", "");
                const idx = mapConfig.findIndex(m => m.name === areaName);
                if(idx !== -1) openDetail(idx);
            }
        });

        function zoomIn() { zoomLevel += 0.1; updateZoom(); }
        function zoomOut() { if(zoomLevel > 0.4) zoomLevel -= 0.1; updateZoom(); }
        function updateZoom() { document.getElementById('projectLayout').style.transform = `scale(${zoomLevel})`; }

        function toggleAuthModal() { if (currentUser) { if(confirm("ƒêƒÉng xu·∫•t?")) auth.signOut(); } else { document.getElementById('loginModal').style.display = 'flex'; } }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }
        function handleLogin() { const e = document.getElementById('loginEmail').value; const p = document.getElementById('loginPass').value; auth.signInWithEmailAndPassword(e, p).then(()=>{closeLogin(); alert("‚úÖ OK");}).catch(e=>alert("‚ùå " + e.message)); }
        
        function handleLotClick(id, title) {
            const d = dbData[id] || {};
            if (!currentUser) { if(d.status === 'sold') alert(`üîí ƒê√É B√ÅN\nüí∞ ${d.price || '...'}`); else if(confirm("ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠a?")) document.getElementById('loginModal').style.display = 'flex'; return; }
            currentId = id; 
            document.getElementById('inpStatus').value = d.status || 'available';
            document.getElementById('inpSeller').value = d.seller || '';
            document.getElementById('inpBuyer').value = d.buyer || '';
            
            // L·∫§Y D·ªÆ LI·ªÜU S·ªê ƒêI·ªÜN THO·∫†I V√Ä V·ªä TR√ç
            document.getElementById('inpPhone').value = d.phone || '';
            document.getElementById('inpLocation').value = d.location || '';
            
            document.getElementById('inpDate').value = d.date || '';
            document.getElementById('inpPrice').value = d.price || '';
            document.getElementById('editModal').style.display = 'flex';
        }
        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
        
        function startConfirm() {
            const st = document.getElementById('inpStatus').value; const lbl = document.getElementById('statusLabel');
            lbl.innerText = (st === 'sold') ? "üî¥ ƒê√É B√ÅN" : "üü¢ ƒêANG M·ªû B√ÅN"; lbl.style.color = (st === 'sold') ? "#c0392b" : "#27ae60";
            document.getElementById('editModal').style.display = 'none'; document.getElementById('confirmModal').style.display = 'flex';
            
            let t = 10; 
            document.getElementById('timerDisplay').innerText = t;
            if(timer) clearInterval(timer); 
            
            timer = setInterval(() => { 
                t--; 
                document.getElementById('timerDisplay').innerText = t; 
                if(t <= 0) {
                    clearInterval(timer);
                    cancelSave(); 
                }
            }, 1000);
        }

        function cancelSave() { clearInterval(timer); document.getElementById('confirmModal').style.display = 'none'; document.getElementById('editModal').style.display = 'flex'; }
        function saveNow() {
            clearInterval(timer); document.getElementById('confirmModal').style.display = 'none';
            
            // L∆ØU C·∫¢ S·ªê ƒêI·ªÜN THO·∫†I V√Ä V·ªä TR√ç
            const data = { 
                status: document.getElementById('inpStatus').value, 
                seller: document.getElementById('inpSeller').value, 
                buyer: document.getElementById('inpBuyer').value, 
                phone: document.getElementById('inpPhone').value, // M·ªõi
                location: document.getElementById('inpLocation').value, // M·ªõi
                date: document.getElementById('inpDate').value, 
                price: document.getElementById('inpPrice').value 
            };
            dbRef.child(currentId).set(data).then(()=>alert("‚úÖ L∆∞u xong!")).catch(e=>alert("‚ùå L·ªói: " + e.message));
        }
    </script>
</body>
</html>
